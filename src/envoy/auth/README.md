# JWT Authentication Proxy

## Overview

__(TODO:figure)__


### Processing flow

Soon after the server runs:

1. This proxy run as a sidecar of the server.
2. Configure which issuers to use, via Envoy config.

Before an user sending request:

1. The user should request an issuer for an access token (JWT)
    - Note: JWT claims should contain `aud`, `sub`, `iss` and `exp`.

For every request from user client:

1. Client send an HTTP request together with JWT, which is intercepted by this proxy
2. The proxy verifies JWT:
    - The signature should be valid
    - JWT should not be expired
    - Issuer (and audience) should be valid
3. If JWT is valid, the user is authenticated and the request will be passed to the server, together with JWT payload (user identity). \
   If JWT is not valid, the request will be discarded and the proxy will send a response with an error message.


## How to build it

* Follow https://github.com/lyft/envoy/blob/master/bazel/README.md to set up environment, and build target envoy:

```
  bazel build //src/envoy:envoy
```

## How to run it

* Start Envoy proxy. Run

```
bazel-bin/src/envoy/envoy -c src/envoy/auth/sample/envoy.conf
```

* Start backend Echo server.

```
go run test/backend/echo/echo.go
```

* Start (fake) issuer server.

```
go run src/envoy/auth/sample/fake_issuer.go src/envoy/auth/sample/pubkey.jwk
```

* Then issue HTTP request to proxy.

With valid JWT:
```
token=`cat src/envoy/auth/sample/correct_jwt`
curl --header "Authorization: Bearer $token" http://localhost:9090/echo -d "hello world"
```
Note: the token is generated by:
* git clone https://github.com/cloudendpoints/esp
* cd esp;  bazel build //src/tools:all
* client/custom/gen-auth-token.sh -s src/nginx/t/matching-client-secret.json

With invalid JWT:
```
token=`cat src/envoy/auth/sample/invalid_jwt`
curl --header "Authorization: Bearer $token" http://localhost:9090/echo -d "hello world"
```

## How it works

### How to receive JWT

If a HTTP request contains a JWT in the HTTP Authorization header:
- `Authorization: Bearer <JWT>` 
Envoy proxy will try to verified it with configured issuers.

### Behavior after verification

- If verification fails, the request will not be passed to the backend and the proxy will send a response with the status code 401 (Unauthorized) and the failure reason as message body.
- If verification succeeds, the request will be passed to the backend, together with an additional HTTP header:
  
  ```
  sec-istio-auth-userinfo: <UserInfo>
  ```
  
  Here, `<UserInfo>` is  base64 encoded payload JSON.
- The authorization header with JWT token is removed.


## How to configure it

### Add this filter to the filter chain

In Envoy config,
```
"filters": [
  {
    "type": "decoder",
    "name": "jwt-auth",
    "config": <config>
  },
  ...
]
```

### Config format

Format of `<config>`:
```
{
 “issuers”:[
   {
     “name”: <issuer name>,
     "audiences": [
       <audience A>,
       <audience B>,
       ...
     ],
     “pubkey”: {
        “type”: <type>, 
        “uri”: <uri>, 
        "cluster": <name of cluster>,
        “value”: <raw string of public key>,
        "cache_expiration_sec": <time in seconds to expire a cached public key>
     }, 
   },
   ...
 ]
}
```

#### issuers (array of object, required)

It specifies the issuers and their public keys.
You can register multiple issuers.


For each issuer, the following informations are required:
- __name__  (string, required): issuer's name. It should be the same as the value of the `iss` claim of a JWT.
- __audiences__ (array of string, optional): 
It specifies the set of acceptable audiences.
If it is specified, JWT must have `aud` claim specified in this list.

- __pubkey__ (object, required): information about public key.
  `type` and (`value` or (`uri` and `cluster`)) are required.
  - __type__ (string, required): the format of public key. It should be one of {`"jwks"`, `"pem"`}.
  - __value__ (string, optional): string of public key.
  - __uri__ (string, optional): URI of the public key server.
  - __cluster__ (string, optional): cluster name of the issuer.  Public key server should be listed in the "clusters" section of the Envoy config. This field refers to its "name" field.
  - __cache_expiration_sec__ (integer, optional): time in seconds to expire a cached public key. If not specified, default is 600 seconds.  Public keys specified in the config "value" field never expire.
  

### Clusters

All public key servers should be listed in the "clusters" section of the Envoy config.  The format of the "url" inside "hosts" section is "tcp://host-name:port".

Example:
```
"clusters": [
  {
    "name": "example_issuer",
    "connect_timeout_ms": 5000,
    "type": "strict_dns",
    "circuit_breakers": {
     "default": {
      "max_pending_requests": 10000,
      "max_requests": 10000
     }
    },
    "lb_type": "round_robin",
    "hosts": [
      {
        "url": "tcp://account.example.com:8080"
      }
    ]
  },
  ...
]
```

